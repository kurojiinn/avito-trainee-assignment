# Полная техническая документация проекта

## Содержание

1. [Архитектура проекта](#архитектура-проекта)
2. [Структура проекта](#структура-проекта)
3. [Модели данных](#модели-данных)
4. [Слои приложения](#слои-приложения)
5. [API Endpoints](#api-endpoints)
6. [База данных](#база-данных)
7. [Бизнес-логика](#бизнес-логика)
8. [Обработка ошибок](#обработка-ошибок)
9. [Тестирование](#тестирование)
10. [Развертывание](#развертывание)

---

## Архитектура проекта

Проект следует принципам **чистой архитектуры (Clean Architecture)** с разделением на слои:

```
┌─────────────────────────────────────┐
│   HTTP Handlers (API Layer)        │  ← Валидация, HTTP коды
├─────────────────────────────────────┤
│   Services (Business Logic)        │  ← Бизнес-правила
├─────────────────────────────────────┤
│   Repositories (Data Access)       │  ← SQL запросы
├─────────────────────────────────────┤
│   Database (PostgreSQL)            │  ← Хранение данных
└─────────────────────────────────────┘
```

### Принципы архитектуры:

1. **Разделение ответственности** - каждый слой отвечает за свою область
2. **Зависимости направлены внутрь** - внешние слои зависят от внутренних
3. **Независимость от фреймворков** - бизнес-логика не зависит от HTTP/БД
4. **Тестируемость** - каждый слой можно тестировать независимо

---

## Структура проекта

```
avito-trainee-assignment/
├── cmd/
│   └── api/
│       └── main.go                 # Точка входа приложения
├── internal/
│   ├── api/
│   │   └── handlers/               # HTTP обработчики
│   │       ├── UserHandler.go
│   │       ├── TeamHandler.go
│   │       ├── PRHandler.go
│   │       └── StatisticsHandler.go
│   ├── config/
│   │   └── Config.go               # Конфигурация из env переменных
│   ├── db/
│   │   └── db.go                   # Подключение к БД
│   ├── model/
│   │   ├── models.go               # Доменные модели
│   │   └── statistics.go           # Модели статистики
│   ├── repository/
│   │   ├── UserRepository.go       # Работа с пользователями
│   │   ├── TeamRepository.go       # Работа с командами
│   │   ├── PRRepository.go         # Работа с PR
│   │   ├── statistics_repository.go
│   │   └── test_helpers.go        # Утилиты для тестов
│   └── service/
│       ├── UserService.go          # Бизнес-логика пользователей
│       ├── TeamService.go          # Бизнес-логика команд
│       ├── PRService.go            # Бизнес-логика PR
│       └── statistics_service.go
├── migrations/
│   └── 20251123102712_create_initial_tables.sql
├── tests/
│   └── e2e_test.go                 # E2E тесты
├── docker-compose.yaml
├── Dockerfile
├── Makefile
└── README.md
```

---

## Модели данных

### User (Пользователь)

```go
type User struct {
    ID       uuid.UUID  // Уникальный идентификатор
    Username string     // Имя пользователя (уникальное)
    TeamID   uuid.UUID // ID команды
    IsActive bool       // Флаг активности
}
```

**Правила:**
- Username должен быть уникальным
- IsActive = false означает, что пользователь не может быть назначен ревьювером
- TeamID может быть пустым (пользователь без команды)

### Team (Команда)

```go
type Team struct {
    ID      uuid.UUID
    Name    string    // Уникальное название
    Members []User    // Список участников (опционально)
}
```

**Правила:**
- Name должен быть уникальным
- Members заполняется при получении команды через API

### PullRequest (Pull Request)

```go
type PullRequest struct {
    ID        uuid.UUID
    Title     string
    AuthorID  uuid.UUID    // ID автора
    Status    PRStatus     // OPEN или MERGED
    Reviewers []uuid.UUID  // Список ревьюверов (до 2)
    CreatedAt time.Time
    MergedAt  *time.Time   // nil если не мержен
}
```

**Правила:**
- При создании автоматически назначаются до 2 активных ревьюверов из команды автора
- Автор не может быть ревьювером своего PR
- После MERGED нельзя изменять список ревьюверов
- Если доступных кандидатов меньше 2, назначается доступное количество (0/1)

---

## Слои приложения

### 1. Handlers (HTTP слой)

**Ответственность:**
- Прием HTTP запросов
- Валидация входных данных (UUID, JSON)
- Преобразование HTTP кодов в ответы
- Вызов сервисов

**Пример:**
```go
func (h *UserHandler) GetUser(w http.ResponseWriter, r *http.Request) {
    // 1. Извлекаем UUID из URL
    // 2. Валидируем UUID
    // 3. Вызываем сервис
    // 4. Возвращаем результат или ошибку
}
```

### 2. Services (Бизнес-логика)

**Ответственность:**
- Реализация бизнес-правил
- Координация работы репозиториев
- Валидация бизнес-правил
- Обработка ошибок бизнес-логики

**Пример:**
```go
func (s *PRService) CreatePR(pr *model.PullRequest) (*model.PullRequest, error) {
    // 1. Проверяем существование автора
    // 2. Получаем активных пользователей команды автора
    // 3. Исключаем автора из кандидатов
    // 4. Выбираем до 2 ревьюверов случайным образом
    // 5. Создаем PR через репозиторий
}
```

### 3. Repositories (Слой данных)

**Ответственность:**
- Выполнение SQL запросов
- Работа с транзакциями
- Преобразование данных БД в модели
- Обработка ошибок БД

**Пример:**
```go
func (r *PRRepository) Create(pr *model.PullRequest, reviewers []uuid.UUID) error {
    // 1. Начинаем транзакцию
    // 2. Вставляем PR
    // 3. Вставляем ревьюверов
    // 4. Коммитим или откатываем транзакцию
}
```

---

## API Endpoints

### Users

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/v1/users` | Создать пользователя |
| GET | `/api/v1/users/{user_id}` | Получить пользователя |
| PUT | `/api/v1/users/{user_id}` | Обновить пользователя |
| DELETE | `/api/v1/users/{user_id}` | Удалить пользователя |
| GET | `/api/v1/users/{user_id}/pull-requests` | Получить PR пользователя |

### Teams

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/v1/teams` | Создать команду |
| GET | `/api/v1/teams/{team_id}` | Получить команду |
| PUT | `/api/v1/teams/{team_id}` | Обновить команду |
| DELETE | `/api/v1/teams/{team_id}` | Удалить команду |
| POST | `/api/v1/teams/{team_id}/deactivate-members` | Деактивировать всех участников |

### Pull Requests

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/v1/pull-requests` | Создать PR (автоматически назначаются ревьюверы) |
| GET | `/api/v1/pull-requests` | Получить все PR |
| GET | `/api/v1/pull-requests/{pr_id}` | Получить PR по ID |
| POST | `/api/v1/pull-requests/{pr_id}/reassign` | Переназначить ревьювера |
| POST | `/api/v1/pull-requests/{pr_id}/merge` | Объединить PR (идемпотентно) |

### Statistics

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/v1/statistics` | Получить статистику по назначениям |

---

## База данных

### Схема БД

```sql
-- Команды
CREATE TABLE teams (
    id UUID PRIMARY KEY,
    name TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP
);

-- Пользователи
CREATE TABLE users (
    id UUID PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    team_id UUID REFERENCES teams(id),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP
);

-- Pull Requests
CREATE TABLE pull_requests (
    id UUID PRIMARY KEY,
    pull_request_name TEXT NOT NULL,
    author_id UUID REFERENCES users(id),
    status pr_status DEFAULT 'OPEN',
    created_at TIMESTAMP,
    merged_at TIMESTAMP
);

-- Связь PR и ревьюверов (many-to-many)
CREATE TABLE pr_reviewers (
    pr_id UUID REFERENCES pull_requests(id),
    reviewer_id UUID REFERENCES users(id),
    assigned_at TIMESTAMP,
    PRIMARY KEY (pr_id, reviewer_id)
);
```

### Индексы

```sql
CREATE INDEX idx_users_team_id ON users(team_id);
CREATE INDEX idx_pr_author ON pull_requests(author_id);
CREATE INDEX idx_pr_reviewers_reviewer ON pr_reviewers(reviewer_id);
CREATE INDEX idx_pr_reviewers_pr ON pr_reviewers(pr_id);
```

### Миграции

Миграции выполняются автоматически при запуске через docker-compose.
Используется библиотека `goose` для управления миграциями.

---

## Бизнес-логика

### Создание PR

1. Проверяется существование автора
2. Получаются активные пользователи команды автора
3. Автор исключается из списка кандидатов
4. Случайным образом выбираются до 2 ревьюверов
5. Если кандидатов меньше 2, назначается доступное количество

### Переназначение ревьювера

1. Проверяется, что PR существует и имеет статус OPEN
2. Проверяется, что старый ревьювер назначен на PR
3. Получаются активные пользователи команды старого ревьювера
4. Исключаются автор PR и старый ревьювер
5. Случайным образом выбирается новый ревьювер
6. Выполняется замена в транзакции

### Объединение PR

1. Проверяется существование PR
2. Если PR уже MERGED, операция идемпотентна (возвращается текущее состояние)
3. Если PR OPEN, статус меняется на MERGED и устанавливается merged_at

### Массовая деактивация

1. Проверяется существование команды
2. Получаются все открытые PR с ревьюверами из команды
3. Для каждого PR переназначаются ревьюверы из деактивируемой команды
4. Деактивируются все активные пользователи команды

---

## Обработка ошибок

### HTTP коды

- **200 OK** - успешный запрос
- **201 Created** - ресурс создан
- **204 No Content** - успешное удаление
- **400 Bad Request** - неверный запрос (невалидный UUID, JSON)
- **404 Not Found** - ресурс не найден
- **409 Conflict** - конфликт (дубликат имени)
- **500 Internal Server Error** - внутренняя ошибка сервера

### Типы ошибок

**Валидация:**
- Неверный формат UUID
- Невалидный JSON
- Отсутствующие обязательные поля

**Бизнес-логика:**
- Пользователь не найден
- Команда не найдена
- PR не найден
- Нельзя переназначить ревьювера в мерженом PR
- Нет доступных ревьюверов

**База данных:**
- Ошибки подключения
- Ошибки транзакций
- Нарушение ограничений (уникальность, внешние ключи)

---

## Тестирование

### Типы тестов

1. **Unit тесты** - тестируют отдельные функции
2. **Integration тесты** - тестируют взаимодействие с БД
3. **E2E тесты** - тестируют полный workflow через HTTP

### Запуск тестов

```bash
# Все тесты
make test

# С покрытием
make test-coverage

# E2E тесты
make e2e-test
```

### Структура тестов

- `internal/repository/*_test.go` - тесты репозиториев
- `internal/service/*_test.go` - тесты сервисов
- `internal/api/handlers/*_test.go` - тесты хэндлеров
- `tests/e2e_test.go` - E2E тесты

---

## Развертывание

### Docker Compose

```bash
docker-compose up
```

Автоматически:
1. Запускает PostgreSQL
2. Применяет миграции
3. Запускает API сервер

### Переменные окружения

```bash
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=avito
POSTGRES_PASSWORD=avito
POSTGRES_DB=mydatabase
PORT=8080
```

### Локальная разработка

```bash
# 1. Запустить БД
docker-compose up -d db

# 2. Применить миграции
make migrate-up

# 3. Запустить сервер
make run
```

---

## Производительность

### Оптимизации

1. **Индексы БД** - созданы на часто используемых полях
2. **Транзакции** - используются для атомарности
3. **Оптимизированные запросы** - минимизировано количество обращений к БД
4. **Эффективные JOIN** - используются для получения связанных данных

### SLI (Service Level Indicators)

- **Время ответа**: < 300 мс (p95)
- **Успешность**: 99.9%
- **RPS**: 5 запросов в секунду
- **Объем данных**: до 20 команд, до 200 пользователей

---

## Безопасность

### Валидация данных

- Все UUID валидируются перед использованием
- Проверяется существование сущностей перед операциями
- Проверяются бизнес-правила

### Транзакции

- Критические операции выполняются в транзакциях
- Используется откат при ошибках
- Обеспечена атомарность операций

---

## Дополнительная информация

### Линтер

Конфигурация `golangci-lint` в `.golangci.yml`

```bash
make lint
```

### Нагрузочное тестирование

Скрипт `load_test.sh` и документация в `LOAD_TESTING.md`

```bash
./load_test.sh
```
